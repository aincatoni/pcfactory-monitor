name: PCFactory Monitor

on:
  schedule:
    # Categor√≠as y delivery cada 10 minutos
    - cron: '*/10 * * * *'
  
  workflow_dispatch:
    inputs:
      producto:
        description: 'ID del producto para delivery'
        required: false
        default: '53880'
      total:
        description: 'Total del carrito'
        required: false
        default: '554990'
      run_payments:
        description: 'Ejecutar monitor de pagos'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      run_login:
        description: 'Ejecutar monitor de login'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ============================================
  # Monitor de Categor√≠as (cada 10 min)
  # ============================================
  monitor-categories:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install google-auth google-auth-oauthlib google-api-python-client
      
      - name: Run category monitor
        run: python monitor.py --workers 5 --output-dir ./output
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      
      - name: Upload category results
        uses: actions/upload-artifact@v4
        with:
          name: category-results
          path: output/
          retention-days: 7

  # ============================================
  # Monitor de Delivery (cada 10 min)
  # ============================================
  monitor-delivery:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Run delivery monitor
        run: |
          python delivery_monitor.py \
            --producto ${{ github.event.inputs.producto || '53880' }} \
            --total ${{ github.event.inputs.total || '554990' }} \
            --ciudades data/ciudad.csv \
            --comunas data/comuna.csv \
            --relacion data/ciudad_comuna.csv \
            --output-dir ./output
      
      - name: Upload delivery results
        uses: actions/upload-artifact@v4
        with:
          name: delivery-results
          path: output/
          retention-days: 7

  # ============================================
  # Verificar si toca correr Payments (4x d√≠a)
  # ============================================
  check-payment-schedule:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if should run payments
        id: check
        run: |
          HOUR=$(date -u +%H)
          MINUTE=$(date -u +%M)
          
          # Horarios UTC para Chile (UTC-3 en verano):
          # 9am Chile  = 12:00 UTC
          # 2pm Chile  = 17:00 UTC
          # 8pm Chile  = 23:00 UTC
          # 10pm Chile = 01:00 UTC (d√≠a siguiente)
          #
          # SOLUCI√ìN: Ventana ampliada a 40 minutos (00-39) para cubrir delays de GitHub Actions
          # El cron corre en :00, :10, :20, :30 de cada hora
          # Con delays de hasta 20 min, las ejecuciones pueden caer en cualquier momento :00-:50
          # Usando :00-:39 evitamos ejecuciones duplicadas en la misma hora
          
          if [[ "${{ github.event.inputs.run_payments }}" == "true" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Manual run requested"
          elif [[ "$HOUR" == "01" || "$HOUR" == "12" || "$HOUR" == "17" || "$HOUR" == "23" ]] && [[ "$MINUTE" -lt "40" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Scheduled run at hour $HOUR:$MINUTE UTC"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Skipping payments (hour=$HOUR, minute=$MINUTE)"
          fi

  # ============================================
  # Verificar si toca correr Login (4x d√≠a)
  # ============================================
  check-login-schedule:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if should run login
        id: check
        run: |
          HOUR=$(date -u +%H)
          MINUTE=$(date -u +%M)
          
          # Horarios UTC para Chile (UTC-3 en verano):
          # 9am Chile  = 12:00 UTC
          # 2pm Chile  = 17:00 UTC
          # 8pm Chile  = 23:00 UTC
          # 10pm Chile = 01:00 UTC (d√≠a siguiente)
          #
          # SOLUCI√ìN: Ventana ampliada a 40 minutos (00-39) para cubrir delays de GitHub Actions
          
          if [[ "${{ github.event.inputs.run_login }}" == "true" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Manual run requested"
          elif [[ "$HOUR" == "01" || "$HOUR" == "12" || "$HOUR" == "17" || "$HOUR" == "23" ]] && [[ "$MINUTE" -lt "40" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Scheduled run at hour $HOUR:$MINUTE UTC"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Skipping login (hour=$HOUR, minute=$MINUTE)"
          fi

  # ============================================
  # Monitor de Medios de Pago (4x d√≠a)
  # ============================================
  monitor-payments:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: check-payment-schedule
    if: needs.check-payment-schedule.outputs.should_run == 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        working-directory: payments
        run: npm install
      
      - name: Install Playwright browsers
        working-directory: payments
        run: npx playwright install chromium --with-deps
      
      - name: Run payment tests
        working-directory: payments
        run: npm test
        continue-on-error: true
      
      - name: Setup Python for dashboard
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Generate payment dashboard
        run: |
          python payment_dashboard.py \
            --results ./payments/test-results/payment-monitor-report.json \
            --output-dir ./output
        continue-on-error: true
      
      - name: Upload payment results
        uses: actions/upload-artifact@v4
        with:
          name: payment-results
          path: |
            output/
            payments/test-results/
          retention-days: 7

  # ============================================
  # Monitor de Login (4x d√≠a)
  # ============================================
  monitor-login:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: check-login-schedule
    if: needs.check-login-schedule.outputs.should_run == 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        working-directory: login
        run: npm install
      
      - name: Install Playwright browsers
        working-directory: login
        run: npx playwright install chromium --with-deps
      
      - name: Create test-results directory
        working-directory: login
        run: mkdir -p test-results/screenshots
      
      - name: Run login tests
        working-directory: login
        run: npm test
        continue-on-error: true
        env:
          PCFACTORY_RUT: ${{ secrets.PCFACTORY_RUT }}
          PCFACTORY_PASSWORD: ${{ secrets.PCFACTORY_PASSWORD }}
      
      - name: Setup Python for dashboard
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Generate login dashboard
        run: |
          python login/scripts/login_dashboard.py \
            --results ./login/test-results/login-monitor-report.json \
            --output-dir ./output
        continue-on-error: true
      
      - name: Upload login results
        uses: actions/upload-artifact@v4
        with:
          name: login-results
          path: |
            output/
            login/test-results/
          retention-days: 7

  # ============================================
  # Deploy a GitHub Pages
  # ============================================
  deploy:
    runs-on: ubuntu-latest
    # IMPORTANTE: Esperar a TODOS los jobs que generan artifacts
    needs: [monitor-categories, monitor-delivery, monitor-payments, monitor-login]
    # Correr si al menos categories o delivery tuvo √©xito (los otros pueden ser skipped)
    if: |
      always() && 
      (needs.monitor-categories.result == 'success' || needs.monitor-delivery.result == 'success')
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0
        continue-on-error: true
      
      - name: Initialize gh-pages if needed
        run: |
          if [ ! -f index.html ]; then
            echo "Initializing gh-pages branch"
            git checkout --orphan gh-pages-temp || true
            echo "<html><body><h1>PCFactory Monitor</h1></body></html>" > index.html
            git add index.html
            git commit -m "Initialize gh-pages" || true
          fi
      
      - name: Download category results
        uses: actions/download-artifact@v4
        with:
          name: category-results
          path: ./new-results/
        continue-on-error: true
      
      - name: Download delivery results
        uses: actions/download-artifact@v4
        with:
          name: delivery-results
          path: ./new-results/
        continue-on-error: true
      
      - name: Download payment results if available
        uses: actions/download-artifact@v4
        with:
          name: payment-results
          path: ./new-results/
        continue-on-error: true
      
      - name: Download login results if available
        uses: actions/download-artifact@v4
        with:
          name: login-results
          path: ./new-results/
        continue-on-error: true
      
      - name: Debug - List downloaded files
        run: |
          echo "üìÅ Contents of new-results:"
          ls -laR ./new-results/ || echo "No new-results directory"
      
      - name: Merge results
        run: |
          # Copiar nuevos resultados
          if [ -d "./new-results" ]; then
            # Copiar archivos HTML directamente
            find ./new-results -name "*.html" -exec cp {} ./ \; 2>/dev/null || true
            find ./new-results -name "*.json" -exec cp {} ./ \; 2>/dev/null || true
          fi
          
          # Crear placeholders solo si no existen los archivos
          if [ ! -f "payments.html" ]; then
            echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Payments Monitor</title><style>body{font-family:sans-serif;background:#1a1a2e;color:#fff;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;}</style></head><body><div style="text-align:center"><h1>üí≥ Medios de Pago</h1><p>El monitor de pagos se ejecuta 4 veces al d√≠a.</p><p>Pr√≥xima ejecuci√≥n: 9am, 2pm, 8pm o 10pm (Chile)</p><a href="index.html" style="color:#9f7aea">‚Üê Volver</a></div></body></html>' > payments.html
          fi
          
          if [ ! -f "login.html" ]; then
            echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Login Monitor</title><style>body{font-family:sans-serif;background:#1a1a2e;color:#fff;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;}</style></head><body><div style="text-align:center"><h1>üîê Login Monitor</h1><p>El monitor de login se ejecuta 4 veces al d√≠a.</p><p>Pr√≥xima ejecuci√≥n: 9am, 2pm, 8pm o 10pm (Chile)</p><a href="index.html" style="color:#9f7aea">‚Üê Volver</a></div></body></html>' > login.html
          fi
          
          # Limpiar
          rm -rf ./new-results
          
          # Listar archivos finales
          echo "üìÅ Final files in gh-pages:"
          ls -la *.html 2>/dev/null || echo "No HTML files"
      
      - name: Commit and push
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add -A
          git diff --staged --quiet || git commit -m "Update dashboards - $(date -u +'%Y-%m-%d %H:%M UTC')"
          git push origin gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
