name: PCFactory Monitor

on:
  schedule:
    - cron: '*/10 * * * *'
  
  workflow_dispatch:
    inputs:
      producto:
        description: 'ID del producto para delivery'
        required: false
        default: '53880'
      total:
        description: 'Total del carrito'
        required: false
        default: '554990'
      run_payments:
        description: 'Ejecutar monitor de pagos'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      run_login:
        description: 'Ejecutar monitor de login'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  monitor-categories:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run category monitor
        run: python monitor.py --workers 5 --output-dir ./output
      - name: Upload category results
        uses: actions/upload-artifact@v4
        with:
          name: category-results
          path: output/
          retention-days: 7

  monitor-delivery:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run delivery monitor
        run: |
          python delivery_monitor.py \
            --producto ${{ github.event.inputs.producto || '53880' }} \
            --total ${{ github.event.inputs.total || '554990' }} \
            --ciudades data/ciudad.csv \
            --comunas data/comuna.csv \
            --relacion data/ciudad_comuna.csv \
            --output-dir ./output
      - name: Upload delivery results
        uses: actions/upload-artifact@v4
        with:
          name: delivery-results
          path: output/
          retention-days: 7

  check-payment-schedule:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if should run payments
        id: check
        run: |
          HOUR=$(date -u +%H)
          MINUTE=$(date -u +%M)
          if [[ "${{ github.event.inputs.run_payments }}" == "true" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          elif [[ "$HOUR" == "01" || "$HOUR" == "12" || "$HOUR" == "17" || "$HOUR" == "23" ]] && [[ "$MINUTE" -lt "40" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  check-login-schedule:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if should run login
        id: check
        run: |
          HOUR=$(date -u +%H)
          MINUTE=$(date -u +%M)
          if [[ "${{ github.event.inputs.run_login }}" == "true" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          elif [[ "$HOUR" == "01" || "$HOUR" == "12" || "$HOUR" == "17" || "$HOUR" == "23" ]] && [[ "$MINUTE" -lt "40" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  monitor-payments:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: check-payment-schedule
    if: needs.check-payment-schedule.outputs.should_run == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        working-directory: payments
        run: npm install
      - name: Install Playwright browsers
        working-directory: payments
        run: npx playwright install chromium --with-deps
      - name: Run payment tests
        working-directory: payments
        run: npm test
        continue-on-error: true
      - name: Setup Python for dashboard
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Generate payment dashboard
        run: |
          python payment_dashboard.py \
            --results ./payments/test-results/payment-monitor-report.json \
            --output-dir ./output
        continue-on-error: true
      - name: Upload payment results
        uses: actions/upload-artifact@v4
        with:
          name: payment-results
          path: |
            output/
            payments/test-results/
          retention-days: 7

  monitor-login:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: check-login-schedule
    if: needs.check-login-schedule.outputs.should_run == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        working-directory: login
        run: npm install
      - name: Install Playwright browsers
        working-directory: login
        run: npx playwright install chromium --with-deps
      - name: Create test-results directory
        working-directory: login
        run: mkdir -p test-results/screenshots
      - name: Run login tests
        working-directory: login
        run: npm test
        continue-on-error: true
        env:
          PCFACTORY_RUT: ${{ secrets.PCFACTORY_RUT }}
          PCFACTORY_PASSWORD: ${{ secrets.PCFACTORY_PASSWORD }}
      - name: Setup Python for dashboard
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Generate login dashboard
        run: |
          python login/scripts/login_dashboard.py \
            --results ./login/test-results/login-monitor-report.json \
            --output-dir ./output
        continue-on-error: true
      - name: Upload login results
        uses: actions/upload-artifact@v4
        with:
          name: login-results
          path: |
            output/
            login/test-results/
          retention-days: 7

  deploy:
    runs-on: ubuntu-latest
    needs: [monitor-categories, monitor-delivery, monitor-payments, monitor-login]
    if: |
      always() && 
      (needs.monitor-categories.result == 'success' || needs.monitor-delivery.result == 'success')
    steps:
      - uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0
        continue-on-error: true
      
      - name: Initialize gh-pages if needed
        run: |
          if [ ! -f index.html ]; then
            git checkout --orphan gh-pages-temp || true
            echo "<html><body><h1>PCFactory Monitor</h1></body></html>" > index.html
            git add index.html
            git commit -m "Initialize gh-pages" || true
          fi
      
      - name: Download category results
        uses: actions/download-artifact@v4
        with:
          name: category-results
          path: ./new-results/
        continue-on-error: true
      
      - name: Download delivery results
        uses: actions/download-artifact@v4
        with:
          name: delivery-results
          path: ./new-results/
        continue-on-error: true
      
      - name: Download payment results if available
        uses: actions/download-artifact@v4
        with:
          name: payment-results
          path: ./new-results/
        continue-on-error: true
      
      - name: Download login results if available
        uses: actions/download-artifact@v4
        with:
          name: login-results
          path: ./new-results/
        continue-on-error: true
      
      - name: Merge results
        run: |
          if [ -d "./new-results" ]; then
            find ./new-results -name "*.html" -exec cp {} ./ \; 2>/dev/null || true
            find ./new-results -name "*.json" -exec cp {} ./ \; 2>/dev/null || true
            find ./new-results -name "*.csv" -exec cp {} ./ \; 2>/dev/null || true
            find ./new-results -name "*.txt" -exec cp {} ./ \; 2>/dev/null || true
          fi
          
          if [ ! -f "payments.html" ]; then
            echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Payments Monitor</title><style>body{font-family:sans-serif;background:#1a1a2e;color:#fff;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;}</style></head><body><div style="text-align:center"><h1>üí≥ Medios de Pago</h1><p>El monitor de pagos se ejecuta 4 veces al dia.</p><a href="index.html" style="color:#9f7aea">‚Üê Volver</a></div></body></html>' > payments.html
          fi
          
          if [ ! -f "login.html" ]; then
            echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Login Monitor</title><style>body{font-family:sans-serif;background:#1a1a2e;color:#fff;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;}</style></head><body><div style="text-align:center"><h1>üîê Login Monitor</h1><p>El monitor de login se ejecuta 4 veces al dia.</p><a href="index.html" style="color:#9f7aea">‚Üê Volver</a></div></body></html>' > login.html
          fi
          
          rm -rf ./new-results
          echo "Final files:"
          ls -la *.html *.csv *.txt *.json 2>/dev/null || echo "No files"
      
      - name: Commit and push
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add -A
          git diff --staged --quiet || git commit -m "Update dashboards - $(date -u +'%Y-%m-%d %H:%M UTC')"
          git push origin gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
