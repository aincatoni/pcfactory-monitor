name: PCFactory Monitor

on:
  schedule:
    - cron: '*/10 * * * *'

  workflow_dispatch:
    inputs:
      producto:
        description: 'ID del producto para delivery'
        required: false
        default: '53880'
      total:
        description: 'Total del carrito'
        required: false
        default: '554990'
      run_payments:
        description: 'Ejecutar monitor de pagos'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  monitor-categories:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run category monitor
        run: python monitor.py --workers 5 --output-dir ./output
      - name: Upload category results
        uses: actions/upload-artifact@v4
        with:
          name: category-results
          path: output/
          retention-days: 7

  monitor-delivery:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run delivery monitor
        run: |
          python delivery_monitor.py \
            --producto ${{ github.event.inputs.producto || '53880' }} \
            --total ${{ github.event.inputs.total || '554990' }} \
            --workers 5 \
            --output-dir ./output \
            --ciudades ./data/ciudad.csv \
            --comunas ./data/comuna.csv \
            --relacion ./data/ciudad_comuna.csv
      - name: Upload delivery results
        uses: actions/upload-artifact@v4
        with:
          name: delivery-results
          path: output/
          retention-days: 7

  check-payment-schedule:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if payments should run
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.run_payments }}" == "true" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            CURRENT_HOUR=$(date -u +%H)
            CURRENT_MIN=$(date -u +%M)
            if [[ "$CURRENT_HOUR" == "12" || "$CURRENT_HOUR" == "17" || "$CURRENT_HOUR" == "23" ]] && [[ "$CURRENT_MIN" -lt "15" ]]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  monitor-payments:
    needs: check-payment-schedule
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: needs.check-payment-schedule.outputs.should_run == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Install Playwright dependencies
        working-directory: ./payments
        run: |
          npm install
          npx playwright install chromium --with-deps

      - name: Run payment tests
        working-directory: ./payments
        run: npx playwright test || true
        continue-on-error: true

      - name: Generate payment dashboard
        run: |
          python payment_dashboard.py \
            --results ./payments/test-results/payment-monitor-report.json \
            --output-dir ./output

      - name: Upload payment results
        uses: actions/upload-artifact@v4
        with:
          name: payment-results
          path: |
            output/payments.html
            output/payment_report.json
            output/payment_history.json
          retention-days: 7

  deploy:
    # âœ… OJO: NO dependemos de monitor-payments (porque es condicional)
    needs: [monitor-categories, monitor-delivery, check-payment-schedule]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Download category results
        uses: actions/download-artifact@v4
        with:
          name: category-results
          path: output/
        continue-on-error: true

      - name: Download delivery results
        uses: actions/download-artifact@v4
        with:
          name: delivery-results
          path: output/
        continue-on-error: true

      - name: Download payment results (if exists)
        uses: actions/download-artifact@v4
        with:
          name: payment-results
